<!DOCTYPE html>
<html lang="en-us" id="extr-page">
<head>
<meta charset="UTF-8">
<link rel="stylesheet" type="text/css" media="screen" href="../../css/bootstrap.min.css">
<link rel="stylesheet" href="../../layui/css/layui.css" media="all" />
</head>
<body>
	<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
		<span style="font-weight:bold;">基本信息</span>
		<hr class="layui-bg-green"></hr>
		<form class="form-horizontal" onsubmit="return false">
			<fieldset>
				<div class="form-group">
					<label class="col-md-2 control-label">编码:</label>
					<div class="col-md-8" style="width:20%">
						<span class="form-control" id="code"></span>
					</div>
					<label class="col-md-2 control-label">类型:</label>
					<div class="col-md-8" style="width:20%">
						<span class="form-control" id="bidType"></span>
					</div>
				</div>
				<div class="form-group">
					<label class="col-md-2 control-label">借款方:</label>
					<div class="col-md-8" style="width:20%">
						<span class="form-control" id="repaymentName"></span>
					</div>
					<label class="col-md-2 control-label">借款总金额(元):</label>
					<div class="col-md-8" style="width:20%">
						<span class="form-control" id="money1"></span>
					</div>
				</div>
				<div class="form-group">
					<label class="col-md-2 control-label">年化率(%):</label>
					<div class="col-md-8" style="width:20%">
						<span class="form-control" id="rateYear1"></span>
					</div>
					<label class="col-md-2 control-label">借款天数:</label>
					<div class="col-md-8" style="width:20%">
						<span class="form-control" id="repaymentDay1"></span>
					</div>
				</div>
				<div class="form-group">
					<label class="col-md-2 control-label">起息日期:</label>
					<div class="col-md-8" style="width:20%">
						<span class="form-control" id="startTime"></span>
					</div>
					<label class="col-md-2 control-label">结束日期:</label>
					<div class="col-md-8" style="width:20%">
						<span class="form-control" id="endTime"></span>
					</div>
				</div>
				<div class="form-group">
					<label class="col-md-2 control-label">最大投资金额(元):</label>
					<div class="col-md-8" style="width:20%">
						<span class="form-control" id="maxMoney"></span>
					</div>
					<label class="col-md-2 control-label">最小投资金额(元):</label>
					<div class="col-md-8" style="width:20%">
						<span class="form-control" id="minMoney"></span>
					</div>
				</div>
				<div class="form-group">
					<label class="col-md-2 control-label">已投资金额(元):</label>
					<div class="col-md-8" style="width:20%">
						<span class="form-control" id="alreadyInvestMoney"></span>
					</div>
					<label class="col-md-2 control-label">状态:</label>
					<div class="col-md-8" style="width:20%">
						<span class="form-control" id="statusShow"></span>
					</div>
				</div>
				<div class="form-group">
					<label class="col-sm-2 control-label"></label>
					<div class="col-sm-4">
						<input type="hidden" id="type" name="type"> 
						<input type="hidden" id="bussessinessId" name="bussessinessId"> 
						<button type="button" class="layui-btn" onclick="showPersonMessage()">
	                        <i class="layui-icon"></i>查看借款人信息
	                    </button>
					</div>
				</div>
			</fieldset>
		</form>
		<span style="font-weight:bold;">审核</span>
		<hr class="layui-bg-green"></hr>
		<div id="detailhtml">
			<form class="form-horizontal" onsubmit="return false">
				<fieldset>
					<div class="form-group">
						<label class="col-md-2 control-label">审核理由:</label>
						<div class="col-md-8" style="width:57%">
							<textarea class="form-control" name="remarkShow" id="remarkShow" readonly></textarea>
						</div>
					</div>
					<div class="form-group">
						<label class="col-md-2 control-label">还款来源:</label>
						<div class="col-md-8" style="width:20%">
							<span class="form-control" id="repaymentSourceShow"></span>
						</div>
						<label class="col-md-2 control-label">平台收取佣金比例(%):</label>
						<div class="col-md-8" style="width:20%">
							<span class="form-control" id="commissionShow"></span>
						</div>
					</div>
					<div class="form-actions">
						<div class="row" align="center">
							<div class="col-md-12">
								<button class="btn btn-primary" onclick="location.href='bidList.html'">返回</button>
							</div>
						</div>
					</div>
				</fieldset>
			</form>
		</div>
		<div id="checkhtml">
			<form class="form-horizontal" onsubmit="return false" id="form">
				<fieldset>
					<input type="hidden" id="id" name="id"> 
					<input type="hidden" id="money" name="money"> 
					<input type="hidden" id="rateYear" name="rateYear"> 
					<input type="hidden" id="repaymentDay" name="repaymentDay"> 
					<input type="hidden" id="commission" name="commission"> 
					<div class="form-group">
						<label class="col-md-2 control-label">审核意见:</label>
						<div class="col-md-8 layui-form" style="width:20%">
							<input type="hidden" id="status" name="status"> 
							<select id="statusSelect" lay-filter="test">
								<option value="1">通过</option>
		                        <option value="4">拒绝</option>
	                        </select>
						</div>
					</div>
					<div class="form-group">
						<label class="col-md-2 control-label">审核理由:</label>
						<input value="ALIYUN" type="hidden" id="fileSource">
						<div class="col-md-8" style="width:57%">
							<textarea class="form-control" name="remark" id="remark" placeholder="审核理由"></textarea>
						</div>
					</div>
					<div class="form-group">
						<label class="col-md-2 control-label">还款来源:</label>
						<div class="col-md-8" style="width:20%">
							<input class="form-control" type="text" name="repaymentSource" id="repaymentSource" placeholder="还款来源">
						</div>
						<label class="col-md-2 control-label">平台收取佣金比例(%):</label>
						<div class="col-md-8" style="width:20%">
							<input class="form-control" type="text" id="commission1" placeholder="平台收取佣金比例(%)">
						</div>
					</div>
					<div class="form-actions">
						<div class="row" align="center">
							<div class="col-md-12">
								<button class="btn btn-primary" onclick="location.href='bidList.html'">返回</button>
								<button class="btn btn-primary" onclick="check()">提交</button>
							</div>
						</div>
					</div>
				</fieldset>
			</form>
		</div>
	</div>
<script src="../../js/constant.js"></script>
<script type="text/javascript" src="../../js/libs/jquery-3.3.1.min.js"></script>
<script type="text/javascript" src="../../js/jq.js"></script>
<script type="text/javascript" src="../../js/plugin/bootstrapvalidator/bootstrapValidator.min.js"></script>
<script type="text/javascript" src="../../js/common.js"></script>
<script type="text/javascript" src="../../layui/layui.js"></script>
<script type="text/javascript" src="../../js/my/permission.js"></script>
<script type="text/javascript" src="../../js/dateUtil.js"></script>
<script type="text/javascript">
var pers = checkPermission();
var layedit;
var layer;
var index;
var indexS;
layui.use(['form','layer','layedit'], function(){
	layer = layui.layer;
	
	var form=layui.form;
	form.render('select');
	
	layedit = layui.layedit;
	  
	//配置图片上传
	layedit.set({
		uploadImage: {
	    	url: domainName + '/zuul/api-f/files/layui?fileSource=' + $("#fileSource").val(), //接口url
			type: 'post'
		}
	});
	
	index=layedit.build('remark'); //建立编辑器
	indexS=layedit.build('remarkShow'); //建立编辑器
	
	initData();
});

function initData(){
	var id=getUrlParam("id");
	$("#id").val(id);
	
	var sign=getUrlParam("sign");
	if(sign == "detail"){
		$("#detailhtml").show();
		$("#checkhtml").hide();
	}else if(sign == "check"){
		$("#detailhtml").hide();
		$("#checkhtml").show();
	}
	
	var type = getUrlParam("type");
	$("#type").val(type);
	
	var bussessinessId = getUrlParam("bussessinessId");
	$("#bussessinessId").val(bussessinessId);
	
	//获取详细信息
	$.ajax({
		type : 'get',
		url : domainName + '/api-P2P/bids/queryOne/'+id,
		success : function(data) {
			if(data!=null){
				var bid = data.bid;
				
				$("#code").html(bid.code);
				
				var bidType = bid.bidType;
				if(bidType == "1"){
					$("#bidType").html("新手标");
				}else if(bidType == "2"){
					$("#bidType").html("产权质押标");
				}else if(bidType == "3"){
					$("#bidType").html("应收款融资标");
				}else{
					$("#bidType").html("");
				}
				
				$("#repaymentName").html(bid.repaymentName);
				$("#money").val(bid.money);
				$("#money1").html(bid.money);
				$("#rateYear").val(bid.rateYear);
				$("#rateYear1").html(accMul(bid.rateYear));
				$("#repaymentDay").val(bid.repaymentDay);
				$("#repaymentDay1").html(bid.repaymentDay);
				
				var startTime = bid.startTime;
				if(startTime == "" || startTime == undefined || startTime == null){
					$("#startTime").html("");
				}else{
					$("#startTime").html(dateFtt("yyyy-MM-dd hh:mm:ss",new Date(startTime)));
				}
				
				var endTime = bid.endTime;
				if(endTime == "" || endTime == undefined || endTime == null){
					$("#endTime").html("");
				}else{
					$("#endTime").html(dateFtt("yyyy-MM-dd hh:mm:ss",new Date(endTime)));
				}
				
				$("#maxMoney").html(bid.maxMoney);
				$("#minMoney").html(bid.minMoney);
				$("#alreadyInvestMoney").html(bid.alreadyInvestMoney);
				
				var status = bid.status;
				if(status == "8"){
					$("#statusShow").html("待审核");
				}else if(status == "1"){
					$("#statusShow").html("投标中");
				}else if(status == "2"){
					$("#statusShow").html("待还款");
				}else if(status == "3"){
					$("#statusShow").html("已还款");
				}else if(status == "4"){
					$("#statusShow").html("审核拒绝");
				}else if(status == "5"){
					$("#statusShow").html("流标");
				}else if(status == "6"){
					$("#statusShow").html("逾期");
				}else if(status == "7"){
					$("#statusShow").html("逾期还款");
				}else{
					$("#statusShow").html("");
				}
				
				if(sign == "detail"){
					layedit.setContent(indexS,bid.remark);
					$("#commissionShow").html(accMul(bid.commission));
					$("#repaymentTypeShow").html(bid.repaymentType);
					$("#repaymentSourceShow").html(bid.repaymentSource);
				}
				
				if(sign == "check"){
					if(data.commissionDefault != undefined){
						$("#commission1").val(accMul(data.commissionDefault));
					}
				}
			}
		}
	});
}

function check(){
	var select=$("#statusSelect").val();
    $("#status").val(select);
    
    if(select == "4"){
    	var remark = layedit.getContent(index);
    	if(remark == ""){
			layer.msg("请填写拒绝原因!");
			return;
		}
    }
    
    var repaymentSource = $("#repaymentSource").val();
    if(repaymentSource.length > 15){
    	layer.msg("请输入15字以内还款来源!");
		return;
    }
    
    $("#remark").val(layedit.getContent(index));
    
    var commission = $("#commission1").val();
    $("#commission").val(accDiv(commission));
    
    var formdata = $("#form").serializeObject();
    
    $.ajax({
		type : 'put',
		url : domainName + '/api-P2P/bids',
		contentType: "application/json; charset=utf-8",  
		data : JSON.stringify(formdata),
		success : function(data) {
			layer.msg("成功", {shift: -1, time: 1000}, function(){
                location.href = "bidList.html";
            });
		}
	});
}

function showPersonMessage(){
	var type = $("#type").val();
	var bidId = $("#id").val();
	
	if(type == "YS"){
		layer.open({
			title:"查看借款人信息",
			type: 2,
			area: ['1000px', '80%'],
			maxmin: true,
			shadeClose: false,
			content: ['showPersonMessageYS.html?bidId='+bidId] 
		})
	}
	if(type == "CQ"){
		layer.open({
			title:"查看借款人信息",
			type: 2,
			area: ['1000px', '80%'],
			maxmin: true,
			shadeClose: false,
			content: ['showPersonMessageCQ.html?bidId='+bidId] 
		})
	}
}
</script>
</body>
</html>